---
---

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrasi - Peacetival</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,#3b82f6 0%, #2563eb 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
      color:#ffffff;
    }
    .container { border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.5); max-width:480px; width:100%; overflow:hidden; position:relative; animation:slideUp .5s ease-out; }
    @keyframes slideUp { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
    .header { background:rgba(251,191,36,0.85); backdrop-filter:blur(10px); padding:20px 30px 18px; text-align:center; color:black; position:relative; display:flex; flex-direction:column; align-items:center; }
    .header img { height:40px; margin-bottom:8px; }
    .header h1 { font-size:18px; font-weight:700; margin:0; }
    .close-icon { position:absolute; top:10px; right:10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; color:#111; background:transparent; text-decoration:none; transition:transform .2s ease,color .2s ease; z-index:5; cursor:pointer; }
    .close-icon:hover { transform:scale(1.05); color:#000; }
    .form-container { padding:24px 24px 16px; background:#0f1e3a; }
    .form-container > * { color:#ffffff; }
    .form-container > p { color:#d1d5db; margin-bottom:12px; font-size:12px; font-style:italic; }
    .divider { position:relative; text-align:center; margin:25px 0; }
    .divider::before { content:''; position:absolute; top:50%; left:0; right:0; height:1px; background:rgba(255,255,255,0.2); z-index:0; }
    .divider span { position:relative; z-index:1; background:#0f1e3a; padding:0 12px; color:rgba(255,255,255,0.85); font-size:13px; font-weight:700; }
    .form-group { margin-bottom:18px; }
    .form-group label { display:block; margin-bottom:8px; color:white; font-weight:600; font-size:14px; }
    .form-group input { width:100%; padding:14px 16px; border:2px solid rgba(255,255,255,0.2); border-radius:10px; font-size:15px; transition:all .3s ease; background:rgba(255,255,255,0.1); color:white; }
    .form-group input::placeholder { color:rgba(255,255,255,0.5); }
    .form-group input:focus { outline:none; border-color:#fbbf24; background:rgba(255,255,255,0.15); box-shadow:0 0 0 3px rgba(251,191,36,0.2); }
    .checkbox-group { display:flex; align-items:center; gap:10px; margin:6px 0 18px; }
    .checkbox-group input { width:auto; padding:0; height:18px; width:18px; cursor:pointer; accent-color:#fbbf24; }
    .checkbox-group label { margin:0; font-size:14px; font-weight:600; color:rgba(255,255,255,0.85); }
    .info-text { font-size:12px; color:rgba(255,255,255,0.55); margin-top:-12px; margin-bottom:16px; line-height:1.4; }
    .btn-submit { width:100%; padding:16px; background:#fbbf24; color:black; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; transition:all .3s ease; margin-top:4px; }
    .btn-submit:hover { transform:translateY(-2px); box-shadow:0 10px 25px rgba(251,191,36,0.4); background:#f59e0b; }
    .btn-submit:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .alert { padding:14px 16px; border-radius:10px; margin-bottom:20px; font-size:14px; animation:slideDown .3s ease-out; }
    @keyframes slideDown { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
    .alert-success { background:#4ade80; color:#ffffff; border:1px solid #22c55e; }
    .alert-error { background:#ef4444; color:#ffffff; border:1px solid #dc2626; }
    .password-field { position:relative; }
    .password-toggle { position:absolute; right:14px; top:50%; transform:translateY(-50%); cursor:pointer; width:20px; height:20px; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.6); background:none; border:none; padding:0; transition:color .2s ease; }
    .password-toggle:hover { color:rgba(255,255,255,0.9); }
    .password-validation { font-size:12px; color:rgba(255,255,255,0.6); margin-top:6px; line-height:1.4; }
    .password-validation .valid { color:#4ade80; }
    .password-validation .invalid { color:#f87171; }
    .password-strength { margin-top:8px; padding:10px 12px; border-radius:8px; font-size:13px; font-weight:600; display:none; }
    .password-strength.visible { display:block; }
    .strength-weak { background:#fca5a5; color:#7f1d1d; }
    .strength-medium { background:#fde047; color:#78350f; }
    .strength-strong { background:#86efac; color:#166534; }
    .login-link { text-align:center; margin-top:22px; padding-top:22px; border-top:1px solid rgba(255,255,255,0.2); color:rgba(255,255,255,0.8); font-size:14px; }
    .login-link a { color:#fbbf24; text-decoration:none; font-weight:600; }
    .peace-club-btn { display:flex; align-items:center; justify-content:center; gap:10px; width:100%; padding:14px; background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3); border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:all .3s ease; text-decoration:none; color:white; }
    .peace-club-btn:hover { background:rgba(255,255,255,0.25); border-color:#fbbf24; transform:translateY(-2px); box-shadow:0 5px 15px rgba(251,191,36,0.3); }
    .loading-spinner { display:inline-block; width:16px; height:16px; border:3px solid rgba(0,0,0,0.15); border-top-color:black; border-radius:50%; animation:spin .8s linear infinite; margin-right:8px; }
    @keyframes spin { to{ transform:rotate(360deg);} }
    @media (max-width:600px){ .container{border-radius:0; max-width:100%;} .header{padding:30px 20px 25px;} .header h1{font-size:22px;} .form-container{padding:20px 16px 12px;} .close-icon{ top:8px; right:8px; width:32px; height:32px;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="close-icon" aria-label="Close" title="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </a>
      <h1>Daftar Akun Peacetival</h1>
    </div>
    <div class="form-container">
      <div id="alertContainer"></div>
      <form id="registerForm">
        <div class="form-group">
          <label>Nama Lengkap</label>
          <input type="text" id="name" placeholder="Nama" required autocomplete="name" />
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="email" placeholder="nama@email.com" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label>WhatsApp</label>
          <input type="tel" id="whatsapp" placeholder="08xxxxxxxxxx" autocomplete="tel" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="password-field">
            <input type="password" id="password" placeholder="Minimal 6 karakter" required autocomplete="new-password" />
            <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility" title="Show/Hide">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5C7 5 2.73 8.11 1 12.46c1.73 4.35 6 7.54 11 7.54s9.27-3.19 11-7.54C21.27 8.11 17 5 12 5m0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3" fill="currentColor"/>
              </svg>
            </button>
          </div>
          <div class="password-strength" id="passwordStrength"></div>
          <div class="password-validation" id="passwordValidation"></div>
        </div>
        <button type="submit" class="btn-submit" id="submitBtn">Registrasi</button>
      </form>
      <div class="divider"><span>atau</span></div>
      <button type="button" class="peace-club-btn" id="peaceClubBtn"><span style="font-size:20px;">✌️</span> Sign in with Peace Club</button>
      <div class="login-link">Sudah punya akun? <a href="/login">Masuk di sini</a></div>
    </div>
  </div>

  <script>
    // @ts-nocheck
    const API_BASE = 'https://auth.ejpeace.my.id/api';
    const form = document.getElementById('registerForm');
    const alertContainer = document.getElementById('alertContainer');
    const submitBtn = document.getElementById('submitBtn');
    const passwordToggle = document.getElementById('passwordToggle');
    const passwordValidation = document.getElementById('passwordValidation');
    function showAlert(message, type='info'){ alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`; if(type!=='error'){ setTimeout(()=>{alertContainer.innerHTML='';},6000); } }

    // Password visibility toggle
    passwordToggle.addEventListener('click', (e) => {
      e.preventDefault();
      const isPassword = document.getElementById('password').type === 'password';
      document.getElementById('password').type = isPassword ? 'text' : 'password';
    });

    // Real-time password validation
    document.getElementById('password').addEventListener('input', (e) => {
      const pwd = e.target.value;
      const passwordStrength = document.getElementById('passwordStrength');
      let html = '';
      const checks = [
        { ok: pwd.length >= 6, msg: 'Minimal 6 karakter' },
        { ok: /[A-Z]/.test(pwd) || pwd.length === 0, msg: 'Huruf besar (opsional)' },
        { ok: /[a-z]/.test(pwd) || pwd.length === 0, msg: 'Huruf kecil (opsional)' },
        { ok: /[0-9]/.test(pwd) || pwd.length === 0, msg: 'Angka (opsional)' }
      ];
      checks.forEach(c => {
        const cls = c.ok ? 'valid' : 'invalid';
        html += `<div class="${cls}">✓ ${c.msg}</div>`;
      });
      passwordValidation.innerHTML = pwd ? html : '';
      
      // Calculate password strength
      if (pwd.length > 0) {
        let strength = 0;
        if (pwd.length >= 6) strength++;
        if (pwd.length >= 10) strength++;
        if (/[a-z]/.test(pwd)) strength++;
        if (/[A-Z]/.test(pwd)) strength++;
        if (/[0-9]/.test(pwd)) strength++;
        if (/[!@#$%^&*(),.?":{}|<>]/.test(pwd)) strength++;
        
        let strengthText = '';
        let strengthClass = '';
        if (strength <= 2) {
          strengthText = 'Kuat Lemah';
          strengthClass = 'strength-weak';
        } else if (strength <= 4) {
          strengthText = 'Kuat Sedang';
          strengthClass = 'strength-medium';
        } else {
          strengthText = 'Kuat Sekali';
          strengthClass = 'strength-strong';
        }
        
        passwordStrength.innerHTML = strengthText;
        passwordStrength.className = `password-strength visible ${strengthClass}`;
      } else {
        passwordStrength.className = 'password-strength';
      }
    });

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/verify`, { credentials: 'include' });
        const data = await response.json();
        if (data.success && data.data.valid) {
          // Store user data in sessionStorage
          sessionStorage.setItem('user', JSON.stringify(data.data.user));
          showAlert('Login berhasil! Mengarahkan...', 'success');
          setTimeout(() => { window.location.href = '/'; }, 800);
          return true;
        }
      } catch (err) {
        console.error('Auth check error:', err);
      }
      return false;
    }

    peaceClubBtn.addEventListener('click', async () => {
      // First, check if already logged in
      if (await checkAuth()) return;

      // Open popup to auth worker's /login endpoint
      const popup = window.open('https://auth.ejpeace.my.id/login', 'peaceclub_login', 'width=600,height=700,scrollbars=yes,resizable=yes');
      if (!popup) {
        showAlert('Popup terblokir. Silakan izinkan popup dan coba lagi.', 'error');
        return;
      }
      window._peaceclubPopup = popup;

      // Poll for auth every 1 second, timeout after 30s
      const start = Date.now();
      const pollInterval = setInterval(async () => {
        // stop if popup was blocked or closed
        if (!popup || popup.closed) {
          clearInterval(pollInterval);
          await checkAuth();
          return;
        }

        // try verification on parent
        if (await checkAuth()) {
          clearInterval(pollInterval);
          try { popup.close(); } catch (e) {}
          return;
        }

        if (Date.now() - start > 30000) {
          clearInterval(pollInterval);
          // give one final try then stop
          await checkAuth();
        }
      }, 1000);
      window._peaceclubPollInterval = pollInterval;
    });
    
    // Listen for SSO completion from popup (/sso/callback will postMessage)
    window.addEventListener('message', async (event) => {
      try {
        const data = event.data || {};
        if (data && data.sso === 'success') {
          if (window._peaceclubPollInterval) { clearInterval(window._peaceclubPollInterval); window._peaceclubPollInterval = null; }
          try { if (window._peaceclubPopup && !window._peaceclubPopup.closed) window._peaceclubPopup.close(); } catch (e) {}
          await checkAuth();
        }
      } catch (e) { console.error('message handler error', e); }
    });
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();
      const password = document.getElementById('password').value;
      if(!name || !email || !password){ showAlert('Nama, email, dan password wajib diisi','error'); return; }
      if(password.length < 6){ showAlert('Password minimal 6 karakter','error'); return; }
      submitBtn.disabled = true; submitBtn.innerHTML = '<span class="loading-spinner"></span> Mengirim...';
      try {
        const response = await fetch(`${API_BASE}/register`, {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ name, email, whatsapp, password, isMember: false, member_type: 'peacetival' })
        });
        const data = await response.json();
        if(response.ok){
          // Store user data in sessionStorage
          sessionStorage.setItem('user', JSON.stringify(data.data.user));
          showAlert('Registrasi berhasil! Mengarahkan ke halaman login...','success');
          setTimeout(()=>{ window.location.href='/login'; }, 1300);
          submitBtn.disabled = false; submitBtn.textContent = 'Registrasi';
        } else {
          if(data.error && data.error.toLowerCase().includes('peace club') || data.error.toLowerCase().includes('member')) {
            showAlert('Email kamu sudah terdaftar di Peace Club! <a href="/login" style="color:#fbbf24;">Login Sekarang</a>','error');
          } else if(data.error && data.error.toLowerCase().includes('already registered') || data.error.toLowerCase().includes('terdaftar')) {
            showAlert('Email sudah terdaftar','error');
          } else {
            showAlert(data.error || 'Registrasi gagal. Periksa data Anda.','error');
          }
          submitBtn.disabled = false; submitBtn.textContent = 'Registrasi';
        }
      } catch(err){
        console.error('Register error:', err);
        showAlert('Tidak dapat terhubung ke server. Coba lagi nanti.','error');
        submitBtn.disabled = false; submitBtn.textContent = 'Registrasi';
      }
    });
  </script>
</body>
</html>
